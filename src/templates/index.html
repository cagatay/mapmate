<!doctype html>
<html>
	<head>
		<title>mapmate</title>
		<meta charset="utf-8"></meta>
		<script src="_ah/channel/jsapi"></script>
		<!-- JQuery Mobile -->
		<link rel="stylesheet" href="http://code.jquery.com/mobile/1.0a2/jquery.mobile-1.0a2.min.css" />
        <script src="http://code.jquery.com/jquery-1.4.4.min.js"></script>
        <script src="http://code.jquery.com/mobile/1.0a2/jquery.mobile-1.0a2.min.js"></script>
		<!--  Google Maps -->
		<script src="http://www.google.com/jsapi"></script> 
		<script src="http://maps.google.com/maps/api/js?sensor=true"></script>
		<style>
			body {
				height: 100%;
				padding: 0;
			}
			#mainPage {
				width: 100%;
				height: 100%;
				padding: 0;
			}
			#content {
				width: 100%;
				padding: 0;
			}
			#map-canvas {
				width: 100%;
				height: 100%;
			}
			.envelope_nm {
				color: red;
				font-size: large;
			}
			.envelope_def {
				color: white;
				font-size: large;
			}
		</style>
	</head>
	<body>
	<script>
	{% if auth %}
	   
		var state = {
				channelKey	: '{{ channelKey }}',
				token		: '{{ token }}',
				map         : null,
				location	: {
					lat	: null,
					lng : null
				},
				bounds		: {
					north_east : {
						lat : null,
						lng : null
					},
					south_west : {
						lat : null,
						lng : null
					}
				},
				socket      : null,
				visibleUsers: new Array(),
				receivedMessages : new Array(),
				sentMessages : new Array()
		};

		var actions = {
				
				initChannel : function () {
			        data = {
					    "function"	: "rpcInit",
					    "location"	: state.location,
					    "bounds"	: state.bounds
			        };
			        sendMessage('/channel', JSON.stringify(data));
		        },
		        
				addUser : function (user) {
			        var marker = new google.maps.Marker({
				        position : new google.maps.LatLng(user['location']['lat'], user['location']['lng']),
				        map      : state.map,
				        title    : user['name']
			        });
			        state.visibleUsers.push(user);
				},

				updateState : function() {
					// TODO: implement
					return;
				},

				closeChannel : function () {
					data = {
					    "function"	: "rpcClose"
					};
					sendMessage('/channel', JSON.stringify(data));
				}
		};

		var mapOptions = {
			    zoom: 17,
			    mapTypeId: google.maps.MapTypeId.ROADMAP,
			    streetViewControl: false,
			    scrollwheel: false,
			    scaleControl: false,
			    navigationControl: false,
			    mapTypeControl: false,
			    keyboardShortcuts: false,
			    disableDoubleClickZoom: true,
			    draggable: false,
			    disableDefaultUI: false
		};

		function initMap() {
			{% if debug %}
		        var location = new google.maps.LatLng({{ lat }}, {{ lng }});
		        state.location.lat = location.lat();
			      state.location.lng = location.lng();
			      mapOptions.center = new google.maps.LatLng(state.location.lat, state.location.lng);
			      state.map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
			      google.maps.event.addListener(state.map, 'tilesloaded', function () {
				      var bounds = state.map.getBounds();
				      var boundne = bounds.getNorthEast();
				      var boundsw = bounds.getSouthWest();
				      state["bounds"]["north_east"]["lat"] = boundne.lat();
				      state["bounds"]["north_east"]["lng"] = boundne.lng();
				      state["bounds"]["south_west"]["lat"] = boundsw.lat();
				      state["bounds"]["south_west"]["lng"] = boundsw.lng();
				      if(state.socket) {
				         actions.updateState();
				      } else {
					     openChannel(); 
				      }
			      });		       
		        
	       {% else %}
	       
	       if(navigator.geolocation) {
			      browserSupportFlag = true;
			      navigator.geolocation.getCurrentPosition(function(position) {
			          var location = new google.maps.LatLng(position.coords.latitude,position.coords.longitude);
			          state.location.lat = location.lat();
			          state.location.lng = location.lng();
			          mapOptions.center = new google.maps.LatLng(state.location.lat, state.location.lng);
			          state.map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions);
			          google.maps.event.addListener(state.map, 'tilesloaded', function () {
				          var bounds = state.map.getBounds();
				          var boundne = bounds.getNorthEast();
				          var boundsw = bounds.getSouthWest();
				          state["bounds"]["north_east"]["lat"] = boundne.lat();
				          state["bounds"]["north_east"]["lng"] = boundne.lng();
				          state["bounds"]["south_west"]["lat"] = boundsw.lat();
				          state["bounds"]["south_west"]["lng"] = boundsw.lng();
				          if(state.socket) {
				              actions.updateState();
				          } else {
					          openChannel(); 
				          }
			          });		        
			      });
	       }	
	       
	       {% endif %}
		}

		function processResponse(message) {
			len = message.length;
			for( var _i = 0; _i < len; _i ++ ) {
				type = message[_i]['type'];
				if( !(typeof type == 'undefined' || type === 'ok' || type === 'error') ) {
					actions[type]( message[_i].data );
				}
			}
		}
		
		function sendMessage(path, param) {
			$.ajax({
				type	: 'POST',
				url		: path,
				data	: param,
				success	: onMessage
			});
		}

		function onMessage(message) {
			message = JSON.parse(message);
			processResponse(message);
		}

		function openChannel() {
			var channel = new goog.appengine.Channel(state.token);
			var handler = {
					'onopen'    : function () { actions.initChannel(); },
					'onmessage' : onMessage,
					'onclose'   : function () { actions.closeChannel(); }
			};
			state.socket = channel.open(handler);
		}

		function fixLayout() {
			var cont = $("#content");
			var headHeight = $("#header").css("height");
			headHeight = headHeight.substring(0, headHeight.length);
			cont.css("height", window.innerHeight - parseInt(headHeight));
		}

		function init() {
			fixLayout();
			$(window).resize(fixLayout);
			
			initMap();
		}

		window.onload = init;
		window.onunload = function() {
			state.socket.close();
			// niyeyse google'in api'i onclose eventini tetiklemiyor
			actions.closeChannel();
		};
			
	{% endif %}
	</script>
	
	<div data-role="page" id="mainPage">
  
	   	<header data-role="header" id="header">
	  		<h1>mapmate</h1>
	  		{% if auth %}
	  		<a href="#settings">settings</a>
	  		<a href="#messages" class="envelope_def" id="msgb">&#9993;</a>
	  		{% else %}
	  		<a href="{{ authlink }}" rel="external">{{ authtext }}</a>
	  		{% endif %}
   		</header>  
	  
   		<div data-role="content" id="content">
   			<div id="map-canvas"></div>
		</div>
 	</div> 
 	
 	<div data-role="page" id="messages">
 		<div data-role="header">
 			<h1>Messages</h1>
 			<a href="#mainPage" data-icon="arrow-l">back</a>
 		</div>
 		<div data-role="content" id="messageList">
 		messages
 		</div>
 	</div>
 	
 	<div data-role="page" id="settings">
		<div data-role="header">
 			<h1>Settings</h1>
 			<a href="#mainPage" data-icon="arrow-l">back</a>
 		</div>
 		<div data-role="content" id="settingList">
 		    <a href="{{ authlink }}" rel="external" data-role="button">{{ authtext }}</a>
 		</div>
 	</div>
	</body>
</html>
